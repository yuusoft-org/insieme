# Messages

This document defines the message envelope and all client/server message schemas for the Insieme sync protocol over WebSocket.

Normative keywords in this document are to be interpreted as described in RFC 2119: `MUST`, `MUST NOT`, `SHOULD`, `SHOULD NOT`, `MAY`.

## Message Envelope

All WebSocket messages (both directions) **MUST** include the following top-level fields:

- `type` (string): message type.
- `msg_id` (string): unique message id for tracing/debug. Generated by the sender and **MUST** be unique per connection. Not used for request/response correlation — use `payload.events[].id` on submit messages and `payload.id` on committed broadcast messages for event correlation; use `payload.partitions` + `since_committed_id` for sync correlation.
- `timestamp` (number): sender time in ms. Client timestamps are informational only; the server uses its own clock for all authoritative timestamps (`status_updated_at`, `server_time`). Server **MUST NOT** reject based only on client clock skew.
- `payload` (object): message-specific payload.
- `protocol_version` (string): current version is `"1.0"`.

Unknown fields **MUST** be ignored to allow forward compatibility.

### Envelope Rules

- Messages missing required envelope fields **MUST** be rejected with `bad_request`.
- If `protocol_version` is unsupported, respond with `error` code `protocol_version_unsupported`, include `payload.details.supported_versions`, and close the connection.
- Unknown message `type` **MUST** be rejected with `bad_request`.

## Protocol Versioning Policy

- `protocol_version` format **MUST** be `MAJOR.MINOR` using decimal integers (for example: `"1.0"`).
- A different `MAJOR` version is a breaking change. Receivers **MUST** reject unsupported major versions with `protocol_version_unsupported`.
- `MINOR` versions are additive/non-breaking only.
- The authoritative compatibility set is `error.payload.details.supported_versions`.
- Clients **SHOULD** send their highest preferred supported version.
- If rejected with `protocol_version_unsupported`, clients **MAY** retry with the highest mutually supported version from `supported_versions`.

## Client → Server

### `connect`

See [connection.md](connection.md) for handshake details.

```yaml
msg_id: msg-1
type: connect
timestamp: 1738451200000
protocol_version: "1.0"
payload:
  token: jwt
  client_id: client-123
  last_committed_id: 1200
  supported_profiles:               # optional, client-supported interface profiles
    - compatibility
    - canonical
  required_profile: compatibility   # optional hard requirement
  required_tree_policy: strict      # optional, only relevant when compatibility is selected
```

Profile negotiation fields:
- Profile names:
  - `compatibility`: tree profile (first-class dynamic/free-form interface).
  - `canonical`: event profile (`type: event` envelope).
- `supported_profiles` is optional. If omitted, server **MUST** assume `[compatibility]`.
- `required_profile` is optional. If present, server **MUST** either select that profile or fail the handshake.
- `required_tree_policy` is optional. If present and tree profile (`compatibility`) is selected, server **MUST** either satisfy it or fail the handshake.
- If no compatible profile is available, server **MUST** send `error(profile_unsupported)` with `details.supported_profiles` and close the connection.

### `submit_events`

`submit_events` is the only submit message type. Single-event submit uses a one-item `payload.events` array.

`payload.events` rules:
- Array **MUST** be non-empty.
- `payload.events[].id` values **MUST** be unique within a single request.
- Duplicate ids in one batch **MUST** be rejected as `bad_request` before item processing.

```yaml
msg_id: msg-batch-1
type: submit_events
timestamp: 1738451201000
protocol_version: "1.0"
payload:
  events:
    - id: evt-uuid-1
      partitions: [workspace-1]
      event:
        type: event
        payload:
          schema: explorer.folderCreated
          data: { id: A, name: Folder A }
    - id: evt-uuid-2
      partitions: [workspace-1]
      event:
        type: event
        payload:
          schema: explorer.folderRenamed
          data: { id: A, name: Folder A2 }
```

### `sync`

```yaml
msg_id: msg-4
type: sync
timestamp: 1738451202000
protocol_version: "1.0"
payload:
  partitions:                       # partitions to fetch events for
    - workspace-1
  subscription_partitions:          # optional: full replacement set for broadcasts
    - workspace-1
    - workspace-2
  since_committed_id: 1200
  limit: 500
```

### `disconnect`

```yaml
msg_id: msg-11
type: disconnect
timestamp: 1738451208000
protocol_version: "1.0"
payload:
  reason: client_shutdown
```

### `heartbeat`

```yaml
msg_id: msg-9
type: heartbeat
timestamp: 1738451207000
protocol_version: "1.0"
payload: {}
```

## Server → Client

### `connected`

See [connection.md](connection.md) for handshake details.

```yaml
msg_id: msg-2
type: connected
timestamp: 1738451200001
protocol_version: "1.0"
payload:
  client_id: client-123
  server_time: 1738451200000
  server_last_committed_id: 1700
  capabilities:                    # required: negotiated connection capabilities
    profile: compatibility         # compatibility(tree) | canonical(event)
    accepted_event_types:
      - set
      - unset
      - treePush
      - treeDelete
      - treeUpdate
      - treeMove
    tree_policy: strict
  model_version: 3                # optional, present in event profile deployments
  limits:                         # optional: server-advertised limits
    max_batch_size: 100
    sync_limit_min: 50
    sync_limit_max: 1000
    max_message_bytes: 1048576
    max_in_flight_drafts: 200
```

### `submit_events_result`

Response to `submit_events` (single-item or batch).

Servers **MUST** return this message for `submit_events`. `results` **MUST** include exactly one entry per submitted item in input order.

Result semantics:
- `status=committed`: item was accepted and durably committed.
- `status=rejected`: item was rejected (for example `validation_failed` or `forbidden`).

```yaml
msg_id: msg-batch-2
type: submit_events_result
timestamp: 1738451202000
protocol_version: "1.0"
payload:
  results:
    - id: evt-uuid-1
      status: committed
      committed_id: 1201
      status_updated_at: 1738451201500
    - id: evt-uuid-2
      status: rejected
      reason: validation_failed      # validation_failed | forbidden
      errors:
        - field: event.payload.data.id
          message: duplicate id
      status_updated_at: 1738451201600
```

Error field path convention:
- `errors[].field` uses dot-path notation relative to a submitted batch item wrapper (`submit_events.payload.events[N]` item shape). Example: `event.payload.data.id`.
- In `submit_events_result` entries with `status=rejected` and `reason=validation_failed`, `errors` **MUST** be present.
- In `submit_events_result` entries with `status=rejected` and `reason=forbidden`, `errors` is optional and **SHOULD** identify denied partitions/resources when present.

### `event_broadcast`

Sent to subscribed clients — notifies peers of a new committed event.

```yaml
msg_id: msg-7
type: event_broadcast
timestamp: 1738451205000
protocol_version: "1.0"
payload:
  id: evt-uuid-1
  client_id: client-123
  partitions:
    - workspace-1
    - workspace-2
  committed_id: 1201
  event:
    type: event
    payload:
      schema: explorer.folderCreated
      data:
        id: A
        name: Folder A
      meta: {}
  status_updated_at: 1738451205000
```

`submit_events_result` confirms outcomes to the origin client. `event_broadcast` notifies subscribed peer clients about committed items. The server **MUST NOT** send `event_broadcast` for an item to the same connection that submitted that item.

### `sync_response`

```yaml
msg_id: msg-8
type: sync_response
timestamp: 1738451206000
protocol_version: "1.0"
payload:
  partitions:
    - workspace-1
  effective_subscriptions:          # current broadcast subscription set
    - workspace-1
    - workspace-2
  model_version: 3                  # optional, present in event profile deployments
  events:                           # committed events, same shape as event_broadcast.payload
    - id: evt-uuid-50
      client_id: client-456
      partitions: [workspace-1]
      committed_id: 1201
      event:
        type: event
        payload:
          schema: explorer.folderCreated
          data: { id: B, name: Folder B }
      status_updated_at: 1738451200000
  next_since_committed_id: 1700     # cursor for next page (use as since_committed_id)
  sync_to_committed_id: 1700        # high-watermark, stable across pages in a sync cycle
  has_more: false
```

Cursor semantics:
- `next_since_committed_id`: if `has_more=true`, the client **MUST** use this value as `since_committed_id` in the next `sync` request. After the final page (`has_more=false`), this is the client's new durable cursor.
- `sync_to_committed_id`: the server's high-watermark when the sync cycle started and **MUST** remain stable across all pages of the same cycle. Used by the client to decide how to handle broadcasts received during sync (see [durability.md](durability.md#broadcast-handling-during-sync)).

### `heartbeat_ack`

```yaml
msg_id: msg-10
type: heartbeat_ack
timestamp: 1738451207001
protocol_version: "1.0"
payload: {}
```

### `error`

```yaml
msg_id: msg-err-1
type: error
timestamp: 1738451207002
protocol_version: "1.0"
payload:
  code: auth_failed
  message: Invalid token
  details: {}                       # optional, error-specific context
```

See [errors.md](errors.md) for the full error codes table.

### `version_changed`

Event profile (`canonical`) only.

```yaml
msg_id: msg-vc-1
type: version_changed
timestamp: 1738451210000
protocol_version: "1.0"
payload:
  old_model_version: 3
  new_model_version: 4
```

`version_changed` is global in scope (not partition-scoped). On receiving it, clients **MUST** invalidate model snapshots and perform a full catch-up (`since_committed_id=0`) for all active model partitions.
