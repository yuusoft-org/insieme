# Messages

This document defines the message envelope and all client/server message schemas for the Insieme sync protocol over WebSocket.

## Message Envelope

All WebSocket messages (both directions) must include the following top-level fields:

- `type` (string): message type.
- `msg_id` (string): unique message id for tracing/debug. Generated by the sender, unique per connection. Not used for request/response correlation — use `payload.id` for event correlation and `payload.partitions` + `since_committed_id` for sync correlation.
- `timestamp` (number): sender time in ms. Client timestamps are informational only; the server uses its own clock for all authoritative timestamps (`status_updated_at`, `server_time`). Server should not reject based on client clock skew.
- `payload` (object): message-specific payload.
- `protocol_version` (string): current version is `"1.0"`.

Unknown fields should be ignored to allow forward compatibility.

### Envelope Rules

- Messages missing required envelope fields must be rejected with `bad_request`.
- If `protocol_version` is unsupported, respond with `error` including `supported_versions` and close the connection.
- Unknown message `type` should be rejected with `bad_request`.

## Client → Server

### `connect`

See [connection.md](connection.md) for handshake details.

```yaml
msg_id: msg-1
type: connect
timestamp: 1738451200000
protocol_version: "1.0"
payload:
  token: jwt
  client_id: client-123
  last_committed_id: 1200
```

### `submit_event`

```yaml
msg_id: msg-3
type: submit_event
timestamp: 1738451201000
protocol_version: "1.0"
payload:
  id: evt-uuid-1                    # globally unique event id
  client_id: client-123             # optional (server uses authenticated identity)
  partitions:
    - workspace-1
    - workspace-2
  event:                            # application-level event
    type: treePush
    payload:
      target: explorer
      value:
        id: A
      options:
        parent: _root
        position: first
```

### `submit_events` (batch)

```yaml
msg_id: msg-batch-1
type: submit_events
timestamp: 1738451201000
protocol_version: "1.0"
payload:
  events:
    - id: evt-uuid-1
      partitions: [workspace-1]
      event:
        type: treePush
        payload:
          target: explorer
          value: { id: A }
          options: { parent: _root }
    - id: evt-uuid-2
      partitions: [workspace-1]
      event:
        type: treeUpdate
        payload:
          target: explorer
          value: { name: Updated }
          options: { id: A }
```

### `sync`

```yaml
msg_id: msg-4
type: sync
timestamp: 1738451202000
protocol_version: "1.0"
payload:
  partitions:                       # partitions to fetch events for
    - workspace-1
  subscription_partitions:          # optional: full replacement set for broadcasts
    - workspace-1
    - workspace-2
  since_committed_id: 1200
  limit: 500
```

### `disconnect`

```yaml
msg_id: msg-11
type: disconnect
timestamp: 1738451208000
protocol_version: "1.0"
payload:
  reason: client_shutdown
```

### `heartbeat`

```yaml
msg_id: msg-9
type: heartbeat
timestamp: 1738451207000
protocol_version: "1.0"
payload: {}
```

## Server → Client

### `connected`

See [connection.md](connection.md) for handshake details.

```yaml
msg_id: msg-2
type: connected
timestamp: 1738451200001
protocol_version: "1.0"
payload:
  client_id: client-123
  server_time: 1738451200000
  server_last_committed_id: 1700
  model_version: 3                # optional, present in model mode
```

### `event_committed`

Sent to origin client only — confirms the submitter's draft was accepted.

```yaml
msg_id: msg-5
type: event_committed
timestamp: 1738451205000
protocol_version: "1.0"
payload:
  id: evt-uuid-1
  client_id: client-123
  partitions:
    - workspace-1
    - workspace-2
  committed_id: 1201
  event:
    type: treePush
    payload:
      target: explorer
      value:
        id: A
      options:
        parent: _root
        position: first
  status_updated_at: 1738451205000
```

### `event_rejected`

Sent to origin client only.

```yaml
msg_id: msg-6
type: event_rejected
timestamp: 1738451205000
protocol_version: "1.0"
payload:
  id: evt-uuid-1
  client_id: client-123
  partitions:
    - workspace-1
  reason: validation_failed
  errors:                           # required when reason is validation_failed
    - field: event.payload.value.id  # path relative to submit_event payload
      message: duplicate id
  status_updated_at: 1738451205000
```

### `event_broadcast`

Sent to other subscribed clients — notifies peers of a new committed event.

```yaml
msg_id: msg-7
type: event_broadcast
timestamp: 1738451205000
protocol_version: "1.0"
payload:
  id: evt-uuid-1
  client_id: client-123
  partitions:
    - workspace-1
    - workspace-2
  committed_id: 1201
  event:
    type: treePush
    payload:
      target: explorer
      value:
        id: A
      options:
        parent: _root
        position: first
  status_updated_at: 1738451205000
```

`event_committed` and `event_broadcast` carry identical payload shapes. The distinction is the audience: `event_committed` goes to the origin client (to confirm its draft), `event_broadcast` goes to peers. Clients should use the message `type` to distinguish, not `payload.client_id`.

### `submit_events_result`

Response to batch submit.

```yaml
msg_id: msg-batch-2
type: submit_events_result
timestamp: 1738451202000
protocol_version: "1.0"
payload:
  results:
    - id: evt-uuid-1
      status: committed
      committed_id: 1201
      status_updated_at: 1738451201500
    - id: evt-uuid-2
      status: rejected
      reason: validation_failed
      errors:
        - field: event.payload.value.id
          message: duplicate id
      status_updated_at: 1738451201600
```

### `sync_response`

```yaml
msg_id: msg-8
type: sync_response
timestamp: 1738451206000
protocol_version: "1.0"
payload:
  partitions:
    - workspace-1
  effective_subscriptions:          # current broadcast subscription set
    - workspace-1
    - workspace-2
  events:                           # committed events, same shape as event_broadcast.payload
    - id: evt-uuid-50
      client_id: client-456
      partitions: [workspace-1]
      committed_id: 1201
      event:
        type: treePush
        payload:
          target: explorer
          value: { id: B }
          options: { parent: _root }
      status_updated_at: 1738451200000
  next_since_committed_id: 1700     # cursor for next page (use as since_committed_id)
  sync_to_committed_id: 1700        # high-watermark, stable across pages in a sync cycle
  has_more: false
```

Cursor semantics:
- `next_since_committed_id`: the value the client should use as `since_committed_id` in the next `sync` request if `has_more=true`. After the final page (`has_more=false`), this is the client's new durable cursor.
- `sync_to_committed_id`: the server's high-watermark when the sync cycle started. Stable across all pages of the same cycle. Used by the client to decide how to handle broadcasts received during sync (see [durability.md](durability.md#broadcast-handling-during-sync)).

### `heartbeat_ack`

```yaml
msg_id: msg-10
type: heartbeat_ack
timestamp: 1738451207001
protocol_version: "1.0"
payload: {}
```

### `error`

```yaml
msg_id: msg-err-1
type: error
timestamp: 1738451207002
protocol_version: "1.0"
payload:
  code: auth_failed
  message: Invalid token
  details: {}                       # optional, error-specific context
```

See [errors.md](errors.md) for the full error codes table.

### `version_changed`

Model mode only.

```yaml
msg_id: msg-vc-1
type: version_changed
timestamp: 1738451210000
protocol_version: "1.0"
payload:
  old_model_version: 3
  new_model_version: 4
```

On receiving `version_changed`, clients must invalidate snapshots for affected partitions and perform a full catch-up (`since_committed_id=0`).
