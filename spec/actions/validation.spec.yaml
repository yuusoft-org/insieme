file: "../../src/validation.js"
group: validation
suites: [testValidateEventPayload, testValidateEventEnvelope, testValidateModelEvent]
---
suite: testValidateEventPayload
exportName: testValidateEventPayload
---
case: "valid set event"
in:
  - set
  - target: "user.name"
    value: "Alice"
out: true
---
case: "valid set event with options"
in:
  - set
  - target: "user"
    value:
      name: "Alice"
    options:
      replace: true
out: true
---
case: "set event missing target"
in:
  - set
  - value: "Alice"
throws: 'Event validation failed for type "set"'
---
case: "set event with empty target"
in:
  - set
  - target: ""
    value: "Alice"
throws: 'Event validation failed for type "set"'
---
case: "set event missing value"
in:
  - set
  - target: "user.name"
throws: 'Event validation failed for type "set"'
---
case: "set event with unknown property"
in:
  - set
  - target: "user.name"
    value: "Alice"
    unknownProp: "bad"
throws: 'Event validation failed for type "set"'
---
case: "set event with target as number"
in:
  - set
  - target: 123
    value: "Alice"
throws: 'Event validation failed for type "set"'
---
case: "set options with unknown property"
in:
  - set
  - target: "user"
    value: {}
    options:
      replace: true
      unknown: "x"
throws: 'Event validation failed for type "set"'
---
case: "set options.replace as string"
in:
  - set
  - target: "user"
    value: {}
    options:
      replace: "yes"
throws: 'Event validation failed for type "set"'
---
case: "valid unset event"
in:
  - unset
  - target: "user.name"
out: true
---
case: "unset event missing target"
in:
  - unset
  - {}
throws: 'Event validation failed for type "unset"'
---
case: "unset event with unknown property"
in:
  - unset
  - target: "user.name"
    extraField: true
throws: 'Event validation failed for type "unset"'
---
case: "unset event with target as object"
in:
  - unset
  - target:
      path: "user"
throws: 'Event validation failed for type "unset"'
---
case: "valid treePush event"
in:
  - treePush
  - target: "explorer"
    value:
      id: "folder1"
      name: "Folder"
out: true
---
case: "valid treePush event with options"
in:
  - treePush
  - target: "explorer"
    value:
      id: "folder1"
    options:
      parent: "_root"
      position: "first"
out: true
---
case: "treePush event missing value.id"
in:
  - treePush
  - target: "explorer"
    value:
      name: "Folder"
throws: 'Event validation failed for type "treePush"'
---
case: "treePush event missing target"
in:
  - treePush
  - value:
      id: "folder1"
throws: 'Event validation failed for type "treePush"'
---
case: "treePush event with unknown property"
in:
  - treePush
  - target: "explorer"
    value:
      id: "f1"
    badProp: 123
throws: 'Event validation failed for type "treePush"'
---
case: "treePush event with value as string"
in:
  - treePush
  - target: "explorer"
    value: "not-an-object"
throws: 'Event validation failed for type "treePush"'
---
case: "treePush event with id as number"
in:
  - treePush
  - target: "explorer"
    value:
      id: 123
throws: 'Event validation failed for type "treePush"'
---
case: "valid treeDelete event"
in:
  - treeDelete
  - target: "explorer"
    options:
      id: "folder1"
out: true
---
case: "treeDelete event missing options"
in:
  - treeDelete
  - target: "explorer"
throws: 'Event validation failed for type "treeDelete"'
---
case: "treeDelete event missing options.id"
in:
  - treeDelete
  - target: "explorer"
    options: {}
throws: 'Event validation failed for type "treeDelete"'
---
case: "valid treeUpdate event"
in:
  - treeUpdate
  - target: "explorer"
    value:
      name: "New"
    options:
      id: "folder1"
out: true
---
case: "treeUpdate event missing value"
in:
  - treeUpdate
  - target: "explorer"
    options:
      id: "folder1"
throws: 'Event validation failed for type "treeUpdate"'
---
case: "treeUpdate event missing options"
in:
  - treeUpdate
  - target: "explorer"
    value:
      name: "New"
throws: 'Event validation failed for type "treeUpdate"'
---
case: "treeUpdate event with value as array"
in:
  - treeUpdate
  - target: "explorer"
    value:
      - "not"
      - "object"
    options:
      id: "f1"
throws: 'Event validation failed for type "treeUpdate"'
---
case: "valid treeMove event"
in:
  - treeMove
  - target: "explorer"
    options:
      id: "folder1"
      parent: "folder2"
out: true
---
case: "treeMove event missing options"
in:
  - treeMove
  - target: "explorer"
throws: 'Event validation failed for type "treeMove"'
---
case: "treeMove event missing options.id"
in:
  - treeMove
  - target: "explorer"
    options:
      parent: "folder2"
throws: 'Event validation failed for type "treeMove"'
---
case: "valid init event"
in:
  - init
  - value:
      explorer:
        items: {}
        tree: []
out: true
---
case: "unknown event type passes validation"
in:
  - unknownType
  - anything: "goes"
throws: 'Event validation failed for type "unknownType"'

---
suite: testValidateEventEnvelope
exportName: testValidateEventEnvelope
---
case: "valid event envelope"
in:
  - schema: "branch.create"
    data:
      name: "feature-x"
    meta:
      author: "alice"
out: true
---
case: "event envelope missing schema"
in:
  - data:
      name: "feature-x"
throws: 'Event validation failed for type "event"'
---
case: "event envelope missing data"
in:
  - schema: "branch.create"
throws: 'Event validation failed for type "event"'
---
case: "event envelope with unknown property"
in:
  - schema: "branch.create"
    data:
      name: "feature-x"
    extra: true
throws: 'Event validation failed for type "event"'

---
suite: testValidateModelEvent
exportName: testValidateModelEvent
---
case: "valid model event"
in:
  - "branch.create"
  - name: "feature-x"
  - branch.create:
      type: "object"
      properties:
        name:
          type: "string"
          minLength: 1
      required: ["name"]
      additionalProperties: false
out: true
---
case: "model event unknown schema"
in:
  - "branch.create"
  - name: "feature-x"
  - {}
throws: "unknown schema"
---
case: "model event invalid payload"
in:
  - "branch.create"
  - {}
  - branch.create:
      type: "object"
      properties:
        name:
          type: "string"
          minLength: 1
      required: ["name"]
      additionalProperties: false
throws: 'Event validation failed for type "branch.create"'
---
case: "model event missing schemas registry"
in:
  - "branch.create"
  - name: "feature-x"
  - ~
throws: 'Model schemas registry is required for type "event".'
